import {Deque} from "@utils/Deque";
import {config, DocumentSizes} from "./utils/interfaces";

const sampleText = "An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.An application programming interface is a connection between computers or between computer programs. It is a type of software interface, offering a service to other pieces of software. A document or standard that describes how to build such a connection or interface is called an API specification.";
// const sampleText = "";

interface RowData {
    cols: number;
    rowsSoFar: number;
}

export class RawEditor {
    private sizes: DocumentSizes;
    private left: string[];
    private right: string[];

    private newlinesLeft: Deque<number>;
    private newlinesRight: Deque<number>;

    private linesSizeLeft: RowData[] = [];
    private linesSizeRight: RowData[] = [];

    private leftRows: number = 1;
    private rightRows: number = 0;

    private columnIndex: number = 0;

    constructor(sizes: DocumentSizes) {
        this.sizes = sizes;
        this.left = [];
        this.right = [];

        this.linesSizeLeft.push({cols: 0, rowsSoFar: 1});

        this.newlinesLeft = new Deque<number>();
        this.newlinesLeft.pushBack(0);
        this.newlinesRight = new Deque<number>();

        // this.insertText(sampleText);
    }

    public getTotalCharsLength(): number {
        return this.left.length + this.right.length;
    }

    public getCursorPosition(): number {
        return this.left.length;
    }

    public getLeftTotalRows(): number {
        return this.leftRows;
    }

    public getRightTotalRows(): number {
        return this.rightRows;
    }

    public getLeftLastRows(): number {
        return this.linesSizeLeft[this.linesSizeLeft.length - 1].rowsSoFar;
    }

    public getTotalRowsDataLength(): number {
        return this.linesSizeLeft.length + this.linesSizeRight.length;
    }

    public getRowDataAtIndex(index: number): RowData {
        if (index < this.linesSizeLeft.length) {
            return this.linesSizeLeft[index];
        } else {
            index -= this.linesSizeLeft.length;
            return this.linesSizeRight[this.linesSizeRight.length - index - 1];
        }
    }

    public getLastLine() {
        return this.newlinesRight.back()!;
    }

    public getActiveLineColumnIndex(): number {
        return this.columnIndex;
    }

    public getTotalCharsBeforeCursor(): string[] {
        return this.left;
    }

    public getTotalCharsAfterCursor(): string[] {
        return this.right;
    }

    public updateRowsSofar(rowData: RowData) {
        rowData.rowsSoFar = Math.ceil(Math.max(this.sizes.cols, rowData.cols) / this.sizes.cols);
        return rowData;
    }

    public insert(char: string) {
        if (char === '\n') return this.insertNewLine();
        if (char === '\t') {
            return this.insertText(new Array(config.tabSize).fill(' ').join(''))
        }
        this.left.push(char);
        this.newlinesLeft.updateBack(this.newlinesLeft.back()! + 1);
        this.columnIndex++;

        const rowData = this.linesSizeLeft[this.linesSizeLeft.length - 1];
        rowData.cols += 1;

        const prevRows = rowData.rowsSoFar;
        this.updateRowsSofar(rowData);

        this.leftRows = this.leftRows - prevRows + rowData.rowsSoFar;

    }

    private insertNewLine() {
        this.left.push("\n");

        let rem = this.newlinesLeft.back()! - this.columnIndex;
        this.newlinesLeft.updateBack(this.columnIndex);
        this.newlinesLeft.pushBack(rem);

        const rowData = this.linesSizeLeft[this.linesSizeLeft.length - 1];
        const prevRows = rowData.rowsSoFar;
        rowData.cols = this.columnIndex;
        this.updateRowsSofar(rowData);
        this.leftRows = this.leftRows - prevRows + rowData.rowsSoFar;

        const newRowData = {cols: rem, rowsSoFar: 0};
        this.updateRowsSofar(newRowData)
        this.linesSizeLeft.push(newRowData);
        this.leftRows += newRowData.rowsSoFar;

        this.columnIndex = 0;
    }

    public getCharAtIndex(index: number) {
        if (index < this.getCursorPosition()) {
            return this.left[index];
        } else {
            index -= this.left.length;
            return this.right[this.right.length - index - 1];
        }
    }

    public getTextUntilPos(pos: number) {
        let diff = this.left.length - pos;

        if (diff < 0) {
            return this.getTextFromRight(-diff);
        } else {
            return this.getTextFromLeft(diff)
        }
    }

    private getTextFromLeft(k: number) {
        let chars = [];
        let i = this.left.length - 1;
        while (i >= 0 && k) {
            chars.push(this.left[i]);
            k--;
            i--;
        }

        return chars.reverse().join('');
    }

    private getTextFromRight(k: number) {
        let chars = [];
        let i = this.right.length - 1;
        while (i >= 0 && k) {
            chars.push(this.right[i]);
            k--;
            i--;
        }

        return chars.join('');
    }

    public backspace(): string {
        return this.deleteLeft(1);
    }

    public deleteKey(): string {
        return this.deleteRight(1);
    }

    private reduceColSizeOnLineSizes() {
        const rowData = this.linesSizeLeft[this.linesSizeLeft.length - 1];
        this.leftRows -= rowData.rowsSoFar;
        rowData.cols -= 1;
        this.updateRowsSofar(rowData);
        this.leftRows += rowData.rowsSoFar;
    }

    public deleteLeft(k: number): string {
        let deleted: string[] = [];
        while (this.left.length && k) {
            let char = <string>this.left.pop();
            if (char == '\n') {
                const curr = this.newlinesLeft.popBack()!;
                this.columnIndex = this.newlinesLeft.back()!;
                this.newlinesLeft.updateBack(this.columnIndex + curr);

                const prevRowData = this.linesSizeLeft.pop()!;
                this.leftRows -= prevRowData.rowsSoFar;
                const rowData = this.linesSizeLeft[this.linesSizeLeft.length - 1];

                const prevRows = rowData.rowsSoFar;
                rowData.cols += prevRowData.cols;
                this.updateRowsSofar(rowData);
                this.leftRows = this.leftRows - prevRows + rowData.rowsSoFar;

            } else {
                this.newlinesLeft.updateBack(this.newlinesLeft.back()! - 1);
                this.columnIndex--;

                this.reduceColSizeOnLineSizes();
            }
            deleted.push(char);
            k--;
        }
        deleted.reverse()
        return deleted.join('');
    }

    public deleteRight(k: number): string {
        let deleted: string[] = [];
        while (this.right.length && k) {
            let char = <string>this.right.pop();
            if (char == '\n') {
                const curr = this.newlinesRight.popFront()!;
                this.newlinesLeft.updateBack(this.newlinesLeft.back()! + curr);

                const prevRowData = this.linesSizeRight.pop()!;
                this.rightRows -= prevRowData.rowsSoFar;
                const rowData = this.linesSizeLeft[this.linesSizeLeft.length - 1];

                const prevRows = rowData.rowsSoFar;
                rowData.cols += prevRowData.cols;
                this.updateRowsSofar(rowData);
                this.leftRows = this.leftRows - prevRows + rowData.rowsSoFar;

            } else {
                this.newlinesLeft.updateBack(this.newlinesLeft.back()! - 1);

                this.reduceColSizeOnLineSizes();
            }
            deleted.push(char);
            k--;
        }
        return deleted.join('');
    }

    public moveLeft(k: number) {
        while (this.left.length && k) {
            let char = this.left.pop();
            this.right.push(<string>char);
            if (char == '\n') {
                this.newlinesRight.pushFront(this.newlinesLeft.popBack()!);
                this.columnIndex = this.newlinesLeft.back()!;

                const prevRowData = this.linesSizeLeft.pop()!;
                this.linesSizeRight.push(prevRowData);

                this.leftRows -= prevRowData.rowsSoFar;
                this.rightRows += prevRowData.rowsSoFar;
            } else {
                this.columnIndex--;
            }
            k--;
        }
    }

    public moveRight(k: number) {
        while (this.right.length && k) {
            let char = this.right.pop();
            if (char == '\n') {
                this.newlinesLeft.pushBack(this.newlinesRight.popFront()!);
                this.columnIndex = 0;

                const prevRowData = this.linesSizeRight.pop()!;
                this.linesSizeLeft.push(prevRowData);

                this.leftRows += prevRowData.rowsSoFar;
                this.rightRows -= prevRowData.rowsSoFar;
            } else {
                this.columnIndex++;
            }
            this.left.push(<string>char);
            k--;
        }
    }

    insertText(pastedText: string) {
        for (let char of pastedText) {
            if (char === '\r') continue;
            this.insert(char);
        }
    }
}